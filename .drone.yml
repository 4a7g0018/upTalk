name: discord-notification-start
kind: pipeline
type: docker

steps:
  - name: title-message
    image: appleboy/drone-discord
    settings:
      webhook_id:
        from_secret: discord_webhook_id
      webhook_token:
        from_secret: discord_webhook_token
      message: |
        ---
        ğŸš© æ¥æ”¶åˆ°ä¾†è‡ª {{repo.name}} {{build.event}} äº‹ä»¶ ğŸš©
        ğŸ—ï¸ New Job #{{build.number}}
        {{build.link}}

---
name: frontend
kind: pipeline
type: docker
depends_on:
  - discord-notification-start

steps:
  - name: test-and-build
    image: node:lts-alpine
    volumes:
      - name: uptalk-nodejs-modules
        path: /drone/src/uptalk_vue/node_modules
      - name: uptalk-nodejs-cache
        path: /root/.npm
    commands:
      - cd uptalk_vue
      - npm install
      - npm run test:unit
      - npm run build

  - name: failed-message
    image: appleboy/drone-discord
    when:
      status:
        - failure
    settings:
      webhook_id:
        from_secret: discord_webhook_id
      webhook_token:
        from_secret: discord_webhook_token
      message: |
        âš ï¸ #{{build.number}} å‰ç«¯å»ºç½®å¤±æ•—ï¼Œè«‹ä¿®å¾©å•é¡Œã€‚ âš ï¸

volumes:
  - name: uptalk-nodejs-modules
    host:
      path: /var/lib/cache/node_modules
  - name: uptalk-nodejs-cache
    host:
      path: /var/lib/cache/.npm

trigger:
  branch:
    - master

---
name: backend
kind: pipeline
type: docker
depends_on:
  - discord-notification-start

steps:
  - name: test-and-build
    image: maven:3.8.5-jdk-8-slim
    volumes:
      - name: uptalk-maven-cache
        path: /root/.m2
      - name: uptalk-backend-target
        path: /drone/src/uptalk_spring/target
    commands:
      - cd uptalk_spring
      - rm -rf /drone/src/uptalk_spring/target/*
      - mvn package

  - name: failed-message
    image: appleboy/drone-discord
    when:
      status:
        - failure
    settings:
      webhook_id:
        from_secret: discord_webhook_id
      webhook_token:
        from_secret: discord_webhook_token
      message: |
        âš ï¸ #{{build.number}} å¾Œç«¯å»ºç½®å¤±æ•—ï¼Œè«‹ä¿®å¾©å•é¡Œã€‚ âš ï¸

volumes:
  - name: uptalk-maven-cache
    host:
      path: /var/lib/cache/.m2
  - name: uptalk-backend-target
    host:
      path: /var/lib/cache/uptalk/target

services:
  - name: postgres
    image: postgres:14-alpine
    environment:
      POSTGRES_PASSWORD: 123456
      POSTGRES_USER: postgres
      POSTGRES_DB: up_talk

trigger:
  branch:
    - master

---
name: sonarqube
kind: pipeline
type: docker
depends_on:
  - frontend
  - backend

steps:
  - name: code-analysis
    image: aosapps/drone-sonar-plugin
    volumes:
      - name: sonar-data
        path: /root/.sonar
      - name: uptalk-backend-target
        path: /drone/src/uptalk_spring/target
    settings:
      sonar_host:
        from_secret: sonar_host
      sonar_token:
        from_secret: sonar_token
      exclusions: "**/dist/**/*.js,**/node_modules/**,**/è¦æ ¼æ›¸/**"
      usingProperties: true

  - name: failed-message
    image: appleboy/drone-discord
    when:
      status:
        - failure
    settings:
      webhook_id:
        from_secret: discord_webhook_id
      webhook_token:
        from_secret: discord_webhook_token
      message: |
        âš ï¸ #{{build.number}} ç¨‹å¼ç¢¼å“è³ªåˆ†æç™¼ç”Ÿå•é¡Œï¼Œè«‹æŸ¥çœ‹å•é¡Œã€‚ âš ï¸

volumes:
  - name: sonar-data
    host:
      path: /var/lib/cache/.sonar
  - name: uptalk-backend-target
    host:
      path: /var/lib/cache/uptalk/target

---
name: publisher
kind: pipeline
type: docker
depends_on:
  - sonarqube

steps:
  - name: frontend
    image: plugins/docker:20.12
    environment:
      DOCKER_BUILDKIT: 1
    volumes:
      - name: uptalk-nodejs-modules
        path: /drone/src/uptalk_vue/node_modules
      - name: uptalk-nodejs-cache
        path: /root/.npm
      - name: docker-sock
        path: /var/run/docker.sock
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_token
      repo: wenwen357951/uptalk-frontend
      tags: latest
      dockerfile: /drone/src/uptalk_vue/Dockerfile
      context: /drone/src/uptalk_vue
      experimental: true

  - name: backend
    image: plugins/docker:20.12
    environment:
      DOCKER_BUILDKIT: 1
    volumes:
      - name: uptalk-maven-cache
        path: /root/.m2
      - name: docker-sock
        path: /var/run/docker.sock
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_token
      repo: wenwen357951/uptalk-backend
      tags: latest
      dockerfile: /drone/src/uptalk_spring/Dockerfile
      context: /drone/src/uptalk_spring
      experimental: true

  - name: success-message
    image: appleboy/drone-discord
    depends_on:
      - frontend
      - backend
    when:
      status:
        - success
        - failure
    settings:
      webhook_id:
        from_secret: discord_webhook_id
      webhook_token:
        from_secret: discord_webhook_token
      message: |
        èŠ±è²»æ™‚é–“: {{since build.started}}
        {{#success build.status}}
        ğŸ‰ #{{build.number}} å»ºç½®å®Œæˆï¼Œå·²ç™¼å¸ƒè‡³ DockerHub ä¸Šã€‚ ğŸ‰
        {{else}}
        âš ï¸ #{{build.number}} ç™¼ä½ˆå¤±æ•—ï¼Œè«‹æŸ¥çœ‹å•é¡Œã€‚ âš ï¸
        {{/success}}

volumes:
  - name: docker-sock
    host:
      path: /var/run/docker.sock
  - name: uptalk-maven-cache
    host:
      path: /var/lib/cache/.m2
  - name: uptalk-backend-target
    host:
      path: /var/lib/cache/uptalk/target
  - name: uptalk-nodejs-modules
    host:
      path: /var/lib/cache/node_modules
  - name: uptalk-nodejs-cache
    host:
      path: /var/lib/cache/.npm
